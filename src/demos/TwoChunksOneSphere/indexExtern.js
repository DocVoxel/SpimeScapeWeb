import{Engine as Ye}from"../Bjs/Bjs_03_04_2022.js";import{Scene as Ze}from"../Bjs/Bjs_03_04_2022.js";import{ArcRotateCamera as Xe}from"../Bjs/Bjs_03_04_2022.js";import{Vector3 as O,Color4 as Ae,Color3 as q}from"../Bjs/Bjs_03_04_2022.js";import{HemisphericLight as et}from"../Bjs/Bjs_03_04_2022.js";import{GroundBuilder as tt}from"../Bjs/Bjs_03_04_2022.js";import{StandardMaterial as k}from"../Bjs/Bjs_03_04_2022.js";import{Mesh as Oe,VertexData as oe,MeshBuilder as ae}from"../Bjs/Bjs_03_04_2022.js";import{Rectangle as nt,StackPanel as ke,TextBlock as Fe,Slider as Re}from"../Bjs/Bjs_03_04_2022.js";import{AdvancedDynamicTexture as it}from"../Bjs/Bjs_03_04_2022.js";import{Vector3 as Y}from"../Bjs/Bjs_03_04_2022.js";import{Vector3 as T,Matrix as pe,Quaternion as Pe}from"../Bjs/Bjs_03_04_2022.js";var J=new T,Be=T.One(),b=class{get position(){return this._position}set position(e){this._position=e,this._calcMatrix=!0}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._calcMatrix=!0}_position=new T;_rotation=new T;_matrix=new pe;_calcMatrix=!0;transformPoint(e){if(this._calcMatrix){this._calcMatrix=!1;let t=Pe.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z);pe.ComposeToRef(Be,t,this._position,this._matrix),this._matrix.invert()}return J.copyFrom(e),T.TransformCoordinatesToRef(e,this._matrix,J),J}},ue=class extends b{sample(e){return 1/0}},he=new ue;var $=class extends b{radius;constructor(e){super();this.radius=e}sample(e){return super.transformPoint(e).length()-this.radius}};import{Vector3 as Se}from"../Bjs/Bjs_03_04_2022.js";function de(s,e){return s>e?s:e}function xe(s,e){return s<e?s:e}function fe(s,e,t){s.x>e.x?t.x=s.x:t.x=e.x,s.y>e.y?t.y=s.y:t.y=e.y}function be(s,e){s.x<0?e.x=-s.x:e.x=s.x,s.y<0?e.y=-s.y:e.y=s.y}var bt=new Se,St=new Se;import{Vector2 as ye}from"../Bjs/Bjs_03_04_2022.js";var zt=new ye,vt=new ye;import{Vector2 as M}from"../Bjs/Bjs_03_04_2022.js";var Ce=new M,we=new M,E=new M,ge=new M,Ge=class extends b{hr=new M;constructor(e,t){super();this.hr.set(e/2,t)}sample(e){return Ce.set(e.x,e.z),we.set(Ce.length(),e.y),be(we,E),E.subtractInPlace(this.hr),fe(E,M.Zero(),ge),xe(de(E.x,E.y),0)+ge.length()}};var N=new Y,We=Math.sqrt(3),ze=new Y,ve=new Y,I=0,P=class{size=0;cells=0;points=0;xStep=1;yStep=0;zStep=0;numSamples=0;xOrigin=0;yOrigin=0;zOrigin=0;stepSize=0;indexMask=0;indexShift=0;indexShiftTimes2=0;neighbourXScale=0;neighbourYScale=0;neighbourZScale=0;cornerOffset=new Int16Array(8);markedSamples;cellToVertexIndex;vertexToCellIndex;sampleMarker=0;field=he;fieldSamples;activeCells=0;constructor(e,t){if((t&t-1)!=0)throw"points must be a power of two";this.size=e,this.cells=t-1,this.points=t,this._calc(),this._calcCornerOffsets(),this.markedSamples=new Int16Array(this.numSamples),this.fieldSamples=new Float32Array(this.numSamples),this.cellToVertexIndex=new Int16Array(this.numSamples),this.vertexToCellIndex=new Int16Array(this.numSamples)}setOrigin(e,t,n){this.xOrigin=e,this.yOrigin=t,this.zOrigin=n}_calc(){this.numSamples=this.points*this.points*this.points,this.yStep=this.points,this.zStep=this.points*this.points,this.stepSize=this.size/this.cells,this.indexShift=0,this.indexMask=0;for(let e=this.points;e>1;e>>=1)this.indexShift++,this.indexMask=this.indexMask<<1|1;this.indexShiftTimes2=this.indexShift*2}_calcCornerOffsets(){let e=0;for(let t=0;t<=1;t++)for(let n=0;n<=1;n++)for(let r=0;r<=1;r++)this.cornerOffset[e]=this.cellIndex(r,n,t),e++}cellIndex(e,t,n){return e+t*this.yStep+n*this.zStep}cellSpaceToWorldSpace(e,t,n,r){r.x=this.xOrigin+e*this.stepSize,r.y=this.yOrigin+t*this.stepSize,r.z=this.zOrigin+n*this.stepSize}cellIndexToCellPosition(e,t){t.set(e&this.indexMask,e>>this.indexShift&this.indexMask,e>>this.indexShiftTimes2&this.indexMask)}indexToWorldSpace(e,t){this.cellIndexToCellPosition(e,N),this.cellSpaceToWorldSpace(N.x,N.y,N.z,t)}getCenter(e){e.x=this.xOrigin+this.size/2,e.y=this.yOrigin+this.size/2,e.z=this.zOrigin+this.size/2}sample(e){return I=0,this.activeCells=0,this.sampleMarker++,this.sampleMarker==65535&&(this.sampleMarker=1,this.markedSamples.fill(0)),this.field=e,this._subDivideCell(0,0,0,this.points),this.activeCells>0}_subDivideCell(e,t,n,r){if(r>1){let i=r>>1;this.cellSpaceToWorldSpace(e+i,t+i,n+i,ze);let o=this.field.sample(ze),c=this.stepSize*i;if(Math.abs(o)>c*We)return;{let u=this.cellIndex(e+i,t+i,n+i);this.fieldSamples[u]=o,I++,this.markedSamples[u]=this.sampleMarker,this._subDivideCell(e,t,n,i),this._subDivideCell(e+i,t,n,i),this._subDivideCell(e,t+i,n,i),this._subDivideCell(e+i,t+i,n,i),this._subDivideCell(e,t,n+i,i),this._subDivideCell(e+i,t,n+i,i),this._subDivideCell(e,t+i,n+i,i),this._subDivideCell(e+i,t+i,n+i,i)}}else this._extractCell(e,t,n)}_extractCell(e,t,n){let r=this.cellIndex(e,t,n),{field:i,sampleMarker:o,markedSamples:c,numSamples:u}=this;if(e>this.cells-1||t>this.cells-1||n>this.cells-1)return 0;let h=0;for(let x=0;x<8;x++){let l=r+this.cornerOffset[x],f;c[l]==o?f=this.fieldSamples[l]:(this.indexToWorldSpace(l,ve),f=i.sample(ve),this.fieldSamples[l]=f,I++,c[l]=o),f<0&&h++}if(h==0||h==8)return 0;this.cellToVertexIndex[r]=this.activeCells,this.vertexToCellIndex[this.activeCells]=r,this.activeCells++}};import{Vector3 as p}from"../Bjs/Bjs_03_04_2022.js";var S=new p,y=new p,Me=new p,Ve=new p,d=new p,B=new p,D=new p,_e,G=new Float32Array(8),A,C,Te=1,Z=2,X=4,ee=8,te=16,ne=32,ie=64,Ke=0,qe=1,He=2,Qe=3,Ue=[[0,1,ee,ie],[0,2,Z,te],[0,4,X,ne],[1,3,0,0],[1,5,0,0],[2,3,0,0],[2,6,0,0],[3,7,0,0],[4,5,0,0],[4,6,0,0],[5,7,0,0],[6,7,0,0]],Ee=[new p(0,0,0),new p(1,0,0),new p(0,1,0),new p(1,1,0),new p(0,0,1),new p(1,0,1),new p(0,1,1),new p(1,1,1)],m,W,a,Ie=0,De,K=0;function re(s,e,t){return a=s,m=e,W=t,{activeCells:Ie,vertexToCellIndex:C,cellToVertexIndex:A,fieldSamples:De,cornerOffset:_e,cells:K}=a,m.length=0,W.length=0,Je(),m.length>0}function se(s,e,t){return s&(e|t|Te)}function je(s,e){if(s.x>K-1||s.y>K-1||s.z>K-1)return 0;let t=0;for(let r=0;r<8;r++){let i=e+_e[r];G[r]=De[i],G[r]<0&&t++}if(t==0||t==8)throw"This should never happen!";let n=$e();return a.cellSpaceToWorldSpace(s.x,s.y,s.z,B),m.push(d.x+B.x,d.y+B.y,d.z+B.z),n}function Je(){for(let s=0;s<Ie;s++){let e=C[s];a.cellIndexToCellPosition(e,D);let t=je(D,e),n=0,r=0,i=0,o=0;D.x==0&&(t=se(t,ee,ie)),D.y==0&&(t=se(t,Z,te)),D.z==0&&(t=se(t,X,ne)),t&Z&&(n=C[s],r=n-a.zStep,i=n-a.zStep-a.xStep,o=n-a.xStep,V(n,r,i,o)),t&te&&(n=C[s],r=n-a.xStep,i=n-a.zStep-a.xStep,o=n-a.zStep,V(n,r,i,o)),t&X&&(n=C[s],r=n-a.xStep,i=n-a.yStep-a.xStep,o=n-a.yStep,V(n,r,i,o)),t&ne&&(n=C[s],r=n-a.yStep,i=n-a.yStep-a.xStep,o=n-a.xStep,V(n,r,i,o)),t&ee&&(n=C[s],r=n-a.yStep,i=n-a.zStep-a.yStep,o=n-a.zStep,V(n,r,i,o)),t&ie&&(n=C[s],r=n-a.zStep,i=n-a.zStep-a.yStep,o=n-a.yStep,V(n,r,i,o))}}function V(s,e,t,n){let r=A[s],i=A[e],o=A[t],c=A[n];if(r<0||i<0||o<0||c<0)return;S.set(m[r*3],m[r*3+1],m[r*3+2]),y.set(m[i*3],m[i*3+1],m[i*3+2]),Me.set(m[o*3],m[o*3+1],m[o*3+2]),Ve.set(m[c*3],m[c*3+1],m[c*3+2]),S.subtractInPlace(Ve),y.subtractInPlace(Me);let u=S.x*S.x+S.y*S.y+S.z*S.z,h=y.x*y.x+y.y*y.y+y.z*y.z;Math.abs(u-h)>1e-6?W.push(r,i,o,o,c,r):W.push(r,i,c,i,o,c)}function $e(){d.set(0,0,0);let s=0,e=0;for(let t=0;t<12;t++){let n=Ue[t],r=G[n[Ke]],i=G[n[qe]],o=r<0,c=i<0;if(o!=c){e|=Te,o?e|=n[Qe]:e|=n[He],s++;let u=r/(r-i),h=1-u,x=Ee[n[0]],l=Ee[n[1]];d.x+=l.x*u+x.x*h,d.y+=l.y*u+x.y*h,d.z+=l.z*u+x.z*h}}return d.x/=s,d.y/=s,d.z/=s,d.x*=a.stepSize,d.y*=a.stepSize,d.z*=a.stepSize,e}var Le=class{engine;canvas;advancedTexture;mesh1Label;panel1;constructor(){this.canvas=document.getElementById("renderCanvas"),this.engine=new Ye(this.canvas,!0,{deterministicLockstep:!0,lockstepMaxSteps:4}),this.panel1=null}async setup(){let e=new Ze(this.engine),t=new Xe("camera",0,Math.PI/3,10,new O(0,0,0),e);t.setTarget(O.Zero()),t.attachControl(this.canvas,!0);let n=new et("light",new O(0,0,0),e);n.intensity=1;let r=tt.CreateGround("ground",{width:20,height:20},e),i=new k("ground material",e);i.wireframe=!0,r.material=i,await e.createDefaultXRExperienceAsync({floorMeshes:[r]});let o=ae.CreateBox("box",{size:4},e),c=new k("boxMaterial",e);c.diffuseColor=new q(0,1,1),c.wireframe=!0,o.material=c;let u=ae.CreateBox("box2",{size:4},e);u.position.x=4;let h=new k("boxMaterial",e);h.diffuseColor=new q(1,1,0),h.wireframe=!0,u.material=h,this._createStatsGui();let x=1e3,l=new $(2);l.position.set(0,1,0);let f=new P(4,16);f.setOrigin(-2,-2,-2);let H=new P(4,8);H.setOrigin(2,-2,-2);let{customMesh:w,vertexData:g}=this._createCustomMesh(e),{customMesh:ce,vertexData:z}=this._createCustomMesh(e),_=[];e.onBeforeAnimationsObservable.add(v=>{let le=v.getStepId();{let F=new Array;l.position=new O(2+Math.sin(le/4e3*Math.PI*2)*4,0,0);let Ne=performance.now();f.sample(l);let j=re(f,g.positions,g.indices),R=performance.now()-Ne,me=I;if(j&&(oe.ComputeNormals(g.positions,g.indices,F),g.normals=F,g.applyToMesh(w,!1)),H.sample(l),j=re(H,z.positions,z.indices),j&&(oe.ComputeNormals(z.positions,z.indices,F),z.normals=F,z.applyToMesh(ce)),l.position=new O(l.position.x,l.position.y,-1),_[0]+=R,le%20==0&&(R=_[0]/20,_[0]=_[1]=_[2]=0,this.panel1)){let L=this.panel1;L.label.text="Samples "+me,L.samplesSlider.value=me,L.timelabel.text="Time "+R.toFixed(3),L.timeSlider.value=R}}});let Q=new k("voxelMaterial",e);Q.wireframe=!0,Q.diffuseColor=new q(.5,1,1),w.material=Q,w.edgesWidth=4,w.edgesColor=new Ae(0,0,1,1);let U=new k("voxelMaterial2",e);U.wireframe=!0,U.diffuseColor=new q(1,1,.5),ce.material=U,w.edgesWidth=4,w.edgesColor=new Ae(0,0,1,1),window.addEventListener("keydown",v=>{v.shiftKey&&v.ctrlKey&&v.altKey&&v.keyCode===73&&(e.debugLayer.isVisible()?e.debugLayer.hide():e.debugLayer.show())}),this.engine.runRenderLoop(()=>{e.render()})}_createStatsGui(){let e=ae.CreatePlane("plane",{size:10});e.position.y=2,e.billboardMode=Oe.BILLBOARDMODE_Y,this.advancedTexture=it.CreateForMesh(e);let t=new ke;t.isVertical=!1,this.advancedTexture.addControl(t),this.panel1=this._createGuiRect(t)}_createCustomMesh(e){let t=new Oe("custom",e),n=new oe;return n.positions=[],n.indices=[],{customMesh:t,vertexData:n}}_createGuiRect(e){let t=new nt;t.width="120px",t.height="80px",t.cornerRadius=10,t.color="Grey",t.thickness=4,t.background="White",e.addControl(t);let n=new ke;t.addControl(n);let r=new Fe;r.text="",r.fontSize="14px",r.paddingTop="4px",r.height="20px",n.addControl(r);let i=new Re;i.color="Orange",i.displayThumb=!1,i.minimum=0,i.maximum=4100,i.value=0,i.height="20px",n.addControl(i);let o=new Fe;o.text="processing time",o.fontSize="14px",o.paddingTop="2px",o.height="18px",n.addControl(o);let c=new Re;return c.color="Blue",c.displayThumb=!1,c.minimum=0,c.maximum=1.2,c.value=0,c.height="20px",n.addControl(c),{label:r,samplesSlider:i,timelabel:o,timeSlider:c}}},rt=new Le;rt.setup().then(()=>{});export{rt as app};
//# sourceMappingURL=indexExtern.js.map
