import{Engine as ht}from"../Bjs/Bjs_03_04_2022.js";import{Scene as bt}from"../Bjs/Bjs_03_04_2022.js";import{ArcRotateCamera as yt}from"../Bjs/Bjs_03_04_2022.js";import{Vector3 as W,Color4 as Vt,Color3 as T}from"../Bjs/Bjs_03_04_2022.js";import{HemisphericLight as gt}from"../Bjs/Bjs_03_04_2022.js";import{GroundBuilder as wt}from"../Bjs/Bjs_03_04_2022.js";import{StandardMaterial as U}from"../Bjs/Bjs_03_04_2022.js";import{Mesh as Oe,VertexData as Ze,MeshBuilder as H}from"../Bjs/Bjs_03_04_2022.js";import{Rectangle as St,StackPanel as Ge,TextBlock as ae,Slider as Re}from"../Bjs/Bjs_03_04_2022.js";import{AdvancedDynamicTexture as zt}from"../Bjs/Bjs_03_04_2022.js";import{Vector3 as P}from"../Bjs/Bjs_03_04_2022.js";var me=new P,Ft=new P;var y={xMin:1,xMax:2,yMin:4,yMax:8,zMin:16,zMax:32},q=class{worldSize=new P;voxelRange=new P;stride=new P;numSamples=0;maxSamples=0;origin=new P;voxelSize=0;halfVoxel=0;borderSeams=0;borderScale=1;constructor(){this.maxSamples=0}setSize(e,n){if(xe(e,this.worldSize),this.voxelRange.x=e.x/n+1,this.voxelRange.y=e.y/n+1,this.voxelRange.z=e.z/n+1,this.stride.x=this.voxelRange.x+1,this.stride.y=this.stride.x*(this.voxelRange.y+1),this.numSamples=this.stride.y*(this.voxelRange.z+1),this.numSamples>65536)throw"chunk resolution exceeds 65536. aborting";this.voxelSize=n,this.halfVoxel=n/2}setBorderSeams(e,n){this.borderSeams=e,this.borderScale=n}setOrigin(e){xe(e,this.origin)}voxelIndexToVoxelPosition(e,n){let r=e;n.x=e%this.stride.x,r-=n.x,n.y=r%this.stride.y/this.stride.x,r-=n.y*this.stride.x,n.z=r/this.stride.y}indexToWorldSpace(e,n){this.voxelIndexToVoxelPosition(e,me),this.voxelSpaceToWorldSpace(me,n)}voxelIndex(e,n,r){return e+n*this.stride.x+r*this.stride.y}voxelSpaceToWorldSpace(e,n){n.x=this.origin.x+e.x*this.voxelSize,n.y=this.origin.y+e.y*this.voxelSize,n.z=this.origin.z+e.z*this.voxelSize}};function xe(t,e){e.x=t.x,e.y=t.y,e.z=t.z}import{Vector3 as l}from"../Bjs/Bjs_03_04_2022.js";var V=new l,L=new l,u=new l,de=new l,Q=new l,_=new l,C=new l,O=new Float32Array(8),$e=Math.sqrt(3);var g=[new l(0,0,0),new l(1,0,0),new l(0,1,0),new l(1,1,0),new l(0,0,1),new l(1,0,1),new l(0,1,1),new l(1,1,1)],Qe=1,fe=2,pe=4,he=8,be=16,ye=32,Ve=64,ge=0,we=1,je=2,Je=3,K=[[0,1,he,Ve],[0,2,fe,be],[0,4,pe,ye],[1,3,0,0],[1,5,0,0],[2,3,0,0],[2,6,0,0],[3,7,0,0],[4,5,0,0],[4,6,0,0],[5,7,0,0],[6,7,0,0]],j=[];for(let t=0;t<K.length;t++)j[t]=new l,j[t].copyFrom(g[K[t][we]]),j[t].subtractInPlace(g[K[t][ge]]);var v,J,m,w,Se=0,ee,F=0,f=1,et=0,N=new l,te=!1,ne=!1,x;function ze(t,e,n,r){return m=t,w=e,xt(m.numSamples),v=n,J=r,F=m.borderSeams,f=m.borderScale,N.copyFrom(m.voxelRange),m.numSamples>Se&&(ee=new Float32Array(m.numSamples),Se=m.numSamples),v.length=0,J.length=0,tt(m)&&(ot(m.voxelRange),ut()),v.length>0}function tt(t){return nt(t)?(te=!1,ne=!1,rt(t),te&&ne):!1}function nt(t){let{worldSize:e,origin:n}=t,r=Math.max(e.x/2,e.y/2,e.z/2);u.set(n.x+e.x/2,n.y+e.y/2,n.z+e.z/2);let o=w.sample(u);return!(Math.abs(o)>r*$e)}var S=new l;function rt(t){let{voxelRange:e}=t;for(let n=0;n<=e.x;n++)for(let r=0;r<=e.y;r++)for(let o=0;o<=e.z;o++){u.set(n,r,o),t.voxelSpaceToWorldSpace(u,S);let s=w.sample(S);s>=0?te=!0:ne=!0;let i=t.voxelIndex(n,r,o);ee[i]=s}}function ot(t){for(let e=0;e<t.x;e++)for(let n=0;n<t.y;n++)for(let r=0;r<t.z;r++)it(e,n,r)}function it(t,e,n){let r=m.voxelIndex(t,e,n),o=0,s=0;for(let i=0;i<8;i++){u.set(t+g[i].x,e+g[i].y,n+g[i].z);let a=m.voxelIndex(u.x,u.y,u.z);O[i]=ee[a],O[i]<0&&o++}return o==0||o==8?(x.connections[r]=0,!1):(s=ct(s,t,e,n,r,1),at(t,e,n)&&st(t,e,n),lt(r,Q),x.connections[r]=s,!0)}function st(t,e,n){let r=t-t%f,o=e-e%f,s=n-n%f;u.set(r,o,s),m.voxelSpaceToWorldSpace(u,S);let i=m.voxelSize*f;for(let a=0;a<8;a++)L.set(S.x+g[a].x*i,S.y+g[a].y*i,S.z+g[a].z*i),O[a]=w.sample(L);Ce(O,V),V.scaleInPlace(i),Q.set(V.x+S.x,V.y+S.y,V.z+S.z)}function at(t,e,n){return!!(F&y.xMin&&t<f||F&y.yMin&&e<f||F&y.zMin&&n<f||F&y.xMax&&t>N.x-f||F&y.yMax&&e>N.y-f||F&y.zMax&&n>N.z-f)}function ct(t,e,n,r,o,s){return t=Ce(O,V),V.scaleInPlace(m.voxelSize*s),de.set(e,n,r),m.voxelSpaceToWorldSpace(de,L),Q.set(V.x+L.x,V.y+L.y,V.z+L.z),t}function lt(t,e){let n=w.sample(e),r=f/1e4;if(Math.abs(n)>r){let o=0;_.set(0,0,0),C.set(e.x+r,e.y-r,e.z-r),o=w.sample(C),_.addInPlaceFromFloats(o,-o,-o),C.set(e.x-r,e.y-r,e.z+r),o=w.sample(C),_.addInPlaceFromFloats(-o,-o,o),C.set(e.x-r,e.y+r,e.z-r),o=w.sample(C),_.addInPlaceFromFloats(-o,o,-o),C.set(e.x+r,e.y+r,e.z+r),o=w.sample(C),_.addInPlaceFromFloats(o,o,o),_.normalize(),_.scaleInPlace(-n)}return v.push(e.x,e.y,e.z),x.lookupVertexFromVoxel[t]=x.vertexCount,x.lookupVoxelFromVertex[x.vertexCount]=t,x.vertexCount++,x.edgeVoxels[x.numEdgesVoxels]=t,x.numEdgesVoxels++,!0}function ut(){for(let t=0;t<x.numEdgesVoxels;t++){let e=x.edgeVoxels[t];m.voxelIndexToVoxelPosition(e,u),mt(x.connections[e])}}function mt(t){u.x==0&&(t=0),u.y==0&&(t=0),u.z==0&&(t=0),t&fe&&B(u,[[0,0,0],[0,0,-1],[-1,0,-1],[-1,0,-1],[-1,0,0],[0,0,0]]),t&be&&B(u,[[0,0,0],[-1,0,0],[-1,0,-1],[-1,0,-1],[0,0,-1],[0,0,0]]),t&pe&&B(u,[[0,0,0],[-1,0,0],[-1,-1,0],[-1,-1,0],[0,-1,0],[0,0,0]]),t&ye&&B(u,[[0,0,0],[0,-1,0],[-1,-1,0],[-1,-1,0],[-1,0,0],[0,0,0]]),t&he&&B(u,[[0,0,0],[0,-1,0],[0,-1,-1],[0,-1,-1],[0,0,-1],[0,0,0]]),t&Ve&&B(u,[[0,0,0],[0,0,-1],[0,-1,-1],[0,-1,-1],[0,-1,0],[0,0,0]])}function Ce(t,e){e.set(0,0,0);let n=0,r=0;for(let o=0;o<12;o++){let s=K[o],i=t[s[ge]],a=t[s[we]],c=i<0,d=a<0;if(c!=d){r|=Qe,c?r|=s[Je]:r|=s[je],n++;let h=i/(i-a),b=1-h,p=g[s[0]],z=g[s[1]];e.x+=z.x*h+p.x*b,e.y+=z.y*h+p.y*b,e.z+=z.z*h+p.z*b}}return e.x/=n,e.y/=n,e.z/=n,r}var Z=new Uint16Array(3),A=[new l,new l,new l],re=1e-6;function B(t,e){for(let n=0;n<e.length;n+=3){let r=!1;for(let a=0;a<3;a++){let c=t.x+e[n+a][0],d=t.y+e[n+a][1],h=t.z+e[n+a][2],b=m.voxelIndex(c,d,h);if(x.connections[b]==0)return;Z[a]=x.lookupVertexFromVoxel[b];let z=Z[a]*3,E=v[z],I=v[z+1],Y=v[z+2];A[a].set(E,I,Y)}let o=A[0].subtract(A[1]).lengthSquared(),s=A[1].subtract(A[2]).lengthSquared(),i=A[2].subtract(A[0]).lengthSquared();(o<re||s<re||i<re)&&(r=!0),r||J.push(Z[0],Z[1],Z[2])}}function xt(t){t>et?x={vertexCount:0,numEdgesVoxels:0,lookupVoxelFromVertex:new Uint16Array(t),lookupVertexFromVoxel:new Uint16Array(t),edgeVoxels:new Uint16Array(t),connections:new Int8Array(t)}:x.vertexCount=0}import{Vector3 as G,Matrix as Me,Quaternion as dt}from"../Bjs/Bjs_03_04_2022.js";var oe=new G,ft=G.One(),M=class{get position(){return this._position}set position(e){this._position=e,this._calcMatrix=!0}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._calcMatrix=!0}_position=new G;_rotation=new G;_matrix=new Me;_calcMatrix=!0;transformPoint(e){if(this._calcMatrix){this._calcMatrix=!1;let n=dt.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z);Me.ComposeToRef(ft,n,this._position,this._matrix),this._matrix.invert()}return oe.copyFrom(e),G.TransformCoordinatesToRef(e,this._matrix,oe),oe}},_e=class extends M{sample(e){return 1/0}},Yt=new _e;import{Vector3 as ie}from"../Bjs/Bjs_03_04_2022.js";function ve(t,e,n){let r=t;return e>r&&(r=e),n>r&&(r=n),r}function Fe(t,e){return t>e?t:e}function Ae(t,e){return t<e?t:e}function ke(t,e,n){t.x>e.x?n.x=t.x:n.x=e.x,t.y>e.y?n.y=t.y:n.y=e.y,t.z>e.z?n.z=t.z:n.z=e.z}function Te(t,e,n){t.x>e.x?n.x=t.x:n.x=e.x,t.y>e.y?n.y=t.y:n.y=e.y}function Ee(t,e){t.x<0?e.x=-t.x:e.x=t.x,t.y<0?e.y=-t.y:e.y=t.y,t.z<0?e.z=-t.z:e.z=t.z}function Ie(t,e){t.x<0?e.x=-t.x:e.x=t.x,t.y<0?e.y=-t.y:e.y=t.y}function De(t,e,n,r,o){o.set(t.x-e,t.y-n,t.z-r)}var k=new ie,Pe=new ie,se=class extends M{width;height;depth;constructor(e,n,r){super();this.width=e/2,this.height=n/2,this.depth=r/2}sample(e){let n=super.transformPoint(e);Ee(n,k),De(k,this.width,this.height,this.depth,k),ke(k,ie.Zero(),Pe);let r=ve(k.x,k.y,k.z);return r>0?Pe.length():r}};import{Vector2 as Le}from"../Bjs/Bjs_03_04_2022.js";var Qt=new Le,jt=new Le;import{Vector2 as X}from"../Bjs/Bjs_03_04_2022.js";var Be=new X,Xe=new X,R=new X,Ye=new X,pt=class extends M{hr=new X;constructor(e,n){super();this.hr.set(e/2,n)}sample(e){return Be.set(e.x,e.z),Xe.set(Be.length(),e.y),Ie(Xe,R),R.subtractInPlace(this.hr),Te(R,X.Zero(),Ye),Ae(Fe(R.x,R.y),0)+Ye.length()}};var $=-3201,We=!0,ce=0,Ue=class{engine;canvas;advancedTexture;mesh1Label;panel1;constructor(){this.canvas=document.getElementById("renderCanvas"),this.engine=new ht(this.canvas,!0,{deterministicLockstep:!0,lockstepMaxSteps:4}),this.panel1=null}async setup(){let e=new bt(this.engine),n=new yt("camera",-Math.PI/4,Math.PI/4,15,new W(0,0,0),e);n.setTarget(W.Zero()),n.attachControl(this.canvas,!0);let r=new gt("light",new W(0,0,0),e);r.intensity=1;let o=wt.CreateGround("ground",{width:40,height:40},e);o.position.y=0,o.isVisible=!0;let s=new U("ground material",e);s.wireframe=!1,o.material=s,await e.createDefaultXRExperienceAsync({floorMeshes:[o]});let i=H.CreateSphere("marker",{diameter:.2},e);i.position.x=8.5,i.position.y=7,i.position.z=4;let a=new U("markerMaterial",e);a.wireframe=!0,a.diffuseColor=new T(1,1,0),a.emissiveColor=new T(1,1,0),i.material=a;let c=H.CreateBox("box",{size:6},e),d=new U("boxMaterial",e);c.position.x=8,c.position.y=5,c.position.z=4,d.diffuseColor=new T(1,0,0),d.wireframe=!0,c.material=d,c.isVisible=!0,n.setTarget(c.position.clone());let h=H.CreateBox("box2",{size:6},e);h.position.x=2;let b=new U("boxMaterial",e);b.diffuseColor=new T(1,0,0),b.wireframe=!0,h.material=b,h.isVisible=!1;let p=new se(6,6,6),z=1e3;p.position.set(0,0,0);let E=new q;E.setSize({x:8,y:8,z:8},1),E.setOrigin({x:0,y:0,z:0});let I=new q;I.setSize({x:8,y:8,z:8},.5),I.setOrigin({x:8,y:0,z:0});let{customMesh:Y,vertexData:qe}=this._createCustomMesh(e),{customMesh:le,vertexData:Ke}=this._createCustomMesh(e),{customMesh:Ne,vertexData:Mt}=this._createCustomMesh(e);e.onBeforeAnimationsObservable.add(D=>{Y.position.y=ce;{We=!1;let He=D.getStepId();{let ue=new Array;p.position=new W(5+Math.sin(He/4e3*Math.PI*2)*6,4,4),c.position.copyFrom(p.position),p.position=new W(c.position.x,c.position.y,c.position.z),E.setBorderSeams(y.xMax,1),this._updateChunk(E,p,qe,ue,Y),I.setBorderSeams(y.xMin,2),this._updateChunk(I,p,Ke,ue,le)}}}),this._setupVoxMaterial(e,Y,new T(0,1,0)),this._setupVoxMaterial(e,le,new T(1,1,0)),this._setupVoxMaterial(e,Ne,new T(1,1,1)),window.addEventListener("keydown",D=>{D.shiftKey&&D.ctrlKey&&D.altKey&&D.keyCode===73&&(e.debugLayer.isVisible()?e.debugLayer.hide():e.debugLayer.show())}),this.engine.runRenderLoop(()=>{e.render()})}_updateChunk(e,n,r,o,s){ze(e,n,r.positions,r.indices)?(Ze.ComputeNormals(r.positions,r.indices,o),r.normals=o,r.applyToMesh(s,!1),s.isVisible=!0):s.isVisible=!1}_setupVoxMaterial(e,n,r){let o=new U("voxelMaterial",e);o.wireframe=!0,o.diffuseColor=r,o.emissiveColor=r,n.material=o,n.enableEdgesRendering(0),n.edgesWidth=4,n.edgesColor=new Vt(0,0,0,1)}_createStatsGui(e){let n=H.CreatePlane("plane",{width:2,height:1.5});n.position.y=3,n.billboardMode=Oe.BILLBOARDMODE_Y,this.advancedTexture=zt.CreateForMesh(n),this.advancedTexture.idealWidth=200;let r=new Ge;return r.isVertical=!1,this.advancedTexture.addControl(r),r.onPointerEnterObservable.add(o=>{e.detachControl()}),r.onPointerOutObservable.add(o=>{e.attachControl(this.canvas,!0)}),this._createGuiRect(r)}_createCustomMesh(e){let n=new Oe("custom",e),r=new Ze;return r.positions=[],r.indices=[],{customMesh:n,vertexData:r}}_createGuiRect(e){let n=new St;n.width="200px",n.height="120px",n.cornerRadius=10,n.color="Grey",n.thickness=4,n.background="White",e.addControl(n);let r=new Ge;n.addControl(r);let o=new ae;o.text="Samples",o.fontSize="14px",o.paddingTop="4px",o.height="20px",r.addControl(o);let s=new ae;s.text=`Position ${$}`,s.fontSize="14px",s.paddingTop="4px",s.height="20px",r.addControl(s);let i=new Re;i.color="Orange",i.minimum=-7e3,i.maximum=7e3,i.value=$,i.height="20px",i.onValueChangedObservable.add(d=>{$=d,We=!0,o.text=`Position ${d}`}),r.addControl(i);let a=new ae;a.text="Samples",a.fontSize="14px",a.paddingTop="4px",a.height="20px",r.addControl(a);let c=new Re;return c.color="Green",c.minimum=0,c.maximum=1e3,c.value=$,c.height="20px",c.onValueChangedObservable.add(d=>{ce=d/1e3,a.text=`Position ${ce.toFixed(3)}`}),r.addControl(c),{samplesLabel:o,positionLabel:s}}},Ct=new Ue;Ct.setup().then(()=>{});export{Ct as app};
//# sourceMappingURL=indexExtern.js.map
